{
  "stories": [
    {
      "title": "Genesis Block Creation Flow",
      "tags": ["call-chain", "genesis", "blockchain"],
      "content": "When initializing a new blockchain, CreateGenesis in genesis.go is called with ChainConfig. It generates a config transaction via genConfigTx() containing chain config as payload, then generates the read-write set via genConfigTxRWSet() which initializes all system contracts. The function calculates hashes: RwSetHash for the transaction, TxHash, then TxRoot (merkle root), RwSetRoot, DagHash, and finally BlockHash. The genesis block has height 0, type CONFIG_BLOCK, and a fixed default timestamp. System contracts are initialized based on block version - newer versions (>=2.3.0) also create address-based contract entries."
    },
    {
      "title": "Transaction Verification Flow",
      "tags": ["call-chain", "transaction", "security"],
      "content": "VerifyTxWithoutPayload verifies a transaction in three steps: (1) verifyTxHeader checks non-nil header, correct chain ID, TxId length/format, timestamp before expiration; (2) verifyTxAuth builds authentication principal from sender endorsement and tx bytes, looks up exceptional policies, then calls AccessControlProvider.VerifyPrincipal; (3) for INVOKE_CONTRACT type with endorsers, additional policy verification is performed including special handling for SELF rule which requires org_id parameter. Payer endorsement is also verified if present."
    },
    {
      "title": "Block Hash Calculation Flow",
      "tags": ["call-chain", "block", "crypto"],
      "content": "CalcBlockHash computes block hash by: (1) copying block header, (2) setting Signature and BlockHash fields to nil, (3) marshaling the header to bytes via protobuf, (4) computing hash using the specified hash type (SHA256, SM3, etc.). This ensures the hash covers all header fields except the signature and hash itself, which are added after signing."
    },
    {
      "title": "WASM Gas Calculation for Syscalls",
      "tags": ["call-chain", "gas", "wasm"],
      "content": "When a WASM contract makes a syscall (e.g., PutState), the gas/wasm module calculates cost based on block version. For version >= 2.3.2: (1) SubtractGasForPutState is called, (2) it retrieves gas prices from wasmDataGasPrice232 map for params/returns, (3) calculateGasForWasmerSyscall232 gets defaultGas from chain config, syscall-specific gas from wasmSyscallGas232 map, (4) common.CalculateGas combines: defaultGas + syscallGas + (paramLen * paramPrice) + (returnLen * returnPrice), (5) txSimContext.SubtractGas deducts from remaining gas. If gas underflows, execution fails."
    },
    {
      "title": "Address Generation from Different Sources",
      "tags": ["call-chain", "address", "identity"],
      "content": "The address module generates addresses from three sources: (1) From public key via PkToAddrStr - for CHAINMAKER type uses SKI (Subject Key Identifier) hash, for ETHEREUM/ZXL uses public key bytes with Keccak256; (2) From certificate via CertToAddrStr - uses SubjectKeyId for CHAINMAKER, marshaled public key for others; (3) From name via NameToAddrStr - applies anti-collision (Keccak256 or SM3 hash of name for version >= 2300) then generates address. All methods call generateAddrStr which applies Keccak256 and takes last 20 bytes for standard addresses, or uses ZXAddress for ZXL type."
    },
    {
      "title": "Blacklist Transaction Filtering",
      "tags": ["call-chain", "security", "filtering"],
      "content": "FilterBlockBlacklistTxs filters transactions by: (1) creating CacheList with chain-specific name ('vm-native' + chainId), (2) iterating through transactions, (3) for each blacklisted TxId (checked via bl.Exists), creating a sanitized transaction copy with contractName and method set to Violation message, parameters cleared, and result message set to Violation, (4) non-blacklisted transactions pass through unchanged. Similar filtering exists for TxRWSet and ContractEvents."
    }
  ]
}
