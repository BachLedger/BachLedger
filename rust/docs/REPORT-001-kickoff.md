# BachLedger Rust 实现 - 启动报告

> 报告编号: REPORT-001
> 日期: 2026-02-06
> 状态: 待决策确认

---

## 1. 项目概述

### 1.1 目标
从零使用 Rust 实现 BachLedger 区块链系统，原生采用 **OEV (Ordering-Execution-Validation)** 架构。

### 1.2 核心特性
| 特性 | 说明 |
|------|------|
| **Seamless Scheduling** | 论文核心算法，跨块无缝调度 |
| **TBFT 共识** | Tendermint BFT 拜占庭容错 |
| **EVM 兼容** | 支持 Solidity 合约执行 |
| **OEV 架构** | 原生实现，非 EOV 改造 |

---

## 2. 系统架构 (UML)

### 2.1 OEV 流水线时序图

```
┌─────────┐   ┌──────────┐   ┌───────────┐   ┌────────────┐   ┌─────────┐
│ TxPool  │   │ Ordering │   │ Execution │   │ Validation │   │ Storage │
└────┬────┘   └────┬─────┘   └─────┬─────┘   └──────┬─────┘   └────┬────┘
     │             │               │                │              │
     │ collect txs │               │                │              │
     │────────────>│               │                │              │
     │             │               │                │              │
     │             │ TBFT consensus│                │              │
     │             │──────────────>│                │              │
     │             │               │                │              │
     │             │               │ Seamless       │              │
     │             │               │ Schedule       │              │
     │             │               │───────────────>│              │
     │             │               │                │              │
     │             │               │                │ 2/3 签名验证 │
     │             │               │                │─────────────>│
     │             │               │                │              │
     │             │    Block N+1 开始 (流水线并行)   │              │
     │             │═══════════════════════════════>│              │
```

### 2.2 模块依赖图

```
                              ┌─────────────┐
                              │  bach-node  │
                              └──────┬──────┘
                                     │
                              ┌──────▼──────┐
                              │  bach-core  │
                              └──────┬──────┘
                    ┌────────────────┼────────────────┐
                    │                │                │
             ┌──────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐
             │bach-consensus│  │bach-scheduler│  │bach-storage │
             │   (TBFT)    │  │ (Seamless)  │  │   (MPT)    │
             └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
                    │                │                │
             ┌──────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐
             │bach-network │  │  bach-evm   │  │ bach-crypto │
             │   (P2P)     │  │             │  │             │
             └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
                    │                │                │
                    └────────────────┼────────────────┘
                                     │
                           ┌─────────▼─────────┐
                           │  bach-primitives  │
                           │  (基础类型定义)    │
                           └───────────────────┘
```

---

## 3. 关键决策点 (需要您确认)

### 3.1 密码学库选择

| 选项 | 优点 | 缺点 | 建议 |
|------|------|------|------|
| **A: k256 (纯Rust)** | 纯 Rust，无 C 依赖，审计良好 | 性能略低于 libsecp256k1 | **推荐** |
| B: libsecp256k1 | Bitcoin Core 使用，性能最优 | C 绑定，编译复杂 | 备选 |
| C: 完全自研 | 无依赖 | 工作量大，安全风险高 | 不推荐 |

**决策问题**: 是否接受使用 `k256` crate 作为 secp256k1 实现？

---

### 3.2 Keccak-256 哈希实现

| 选项 | 代码量 | 安全性 | 建议 |
|------|--------|--------|------|
| **A: 自研** | ~500 LOC | 需充分测试 | **可行** |
| B: sha3 crate | 0 | 已审计 | 备选 |

**决策问题**: 是否自研 Keccak-256？（可完全无外部依赖）

---

### 3.3 持久化存储

| 选项 | 复杂度 | 性能 | 建议 |
|------|--------|------|------|
| **A: 自研简化KV** | 中 | 够用 | **MVP阶段推荐** |
| B: RocksDB | 低（用现成） | 最优 | 生产环境 |
| C: sled (纯Rust) | 低 | 良好 | 备选 |

**决策问题**: MVP 阶段是否使用自研简化 KV 存储？

---

### 3.4 网络层实现

| 选项 | 复杂度 | 功能 | 建议 |
|------|--------|------|------|
| **A: 基于 std::net 自研** | 高 | 基础 TCP/UDP | **MVP推荐** |
| B: tokio + 自研协议 | 中 | 异步高性能 | 后期优化 |
| C: libp2p | 低 | 功能完整 | 如需快速原型 |

**决策问题**: 是否接受 MVP 阶段使用 `tokio` 进行异步网络？

---

### 3.5 大整数 U256

| 选项 | 代码量 | 建议 |
|------|--------|------|
| **A: 自研** | ~1000 LOC | **可行，EVM需要** |
| B: primitive-types | 0 | 备选 |

**决策问题**: 是否自研 U256？（EVM 必需，自研可完全控制）

---

## 4. 风险分析

### 4.1 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| EVM 实现不完整 | 高 | 高 | 使用 Ethereum 官方测试向量验证 |
| TBFT 实现有 bug | 中 | 高 | 分阶段测试，先单节点后多节点 |
| Seamless Scheduling 性能不达标 | 中 | 中 | 建立基准测试，持续监控 |
| 自研组件安全漏洞 | 中 | 高 | Critic 严格审查，覆盖边界情况 |

### 4.2 进度风险

| 风险 | 缓解措施 |
|------|----------|
| 模块间接口不匹配 | 先定义 trait，再实现 |
| 测试覆盖不足 | Tester 独立编写，目标是找 bug |
| 文档落后于代码 | 每个 PR 必须更新相关文档 |

---

## 5. 资源需求

### 5.1 开发资源
- **不需要**外部服务器（本地开发测试）
- **不需要**数据库服务（自研存储）
- **不需要**密钥/API Key

### 5.2 测试资源
- Ethereum 官方 EVM 测试向量（公开可下载）
- TBFT 共识测试场景（自行构造）

---

## 6. 开发阶段划分

```
Phase 1: 基础设施 ──────────────────────────────────────┐
├── bach-primitives (基础类型)                          │ Week 1-2
├── bach-crypto (Keccak-256, 签名)                      │
└── 单元测试框架                                         │
                                                        │
Phase 2: 核心算法 ──────────────────────────────────────┤
├── bach-scheduler (Seamless Scheduling)               │ Week 3-4
├── PriorityCode, OwnershipTable                       │
└── 算法正确性验证                                       │
                                                        │
Phase 3: EVM 执行引擎 ─────────────────────────────────┤
├── bach-evm (操作码实现)                               │ Week 5-7
├── bach-storage (状态存储, MPT)                        │
└── Ethereum 测试向量验证                                │
                                                        │
Phase 4: 共识与网络 ───────────────────────────────────┤
├── bach-consensus (TBFT)                              │ Week 8-9
├── bach-network (P2P)                                 │
└── bach-txpool (交易池)                                │
                                                        │
Phase 5: 集成 ─────────────────────────────────────────┤
├── bach-core (流程编排)                                │ Week 10-11
├── bach-node (节点程序)                                │
└── 端到端测试                                          │
                                                        │
Phase 6: 优化 ─────────────────────────────────────────┘
├── 性能优化                                            Week 12+
├── 安全审计
└── 基准测试对比
```

---

## 7. 团队分工

| 角色 | 职责 | 数量 |
|------|------|------|
| **Architect** | 架构设计、接口定义、关键决策 | 1 |
| **Coder** | 代码实现、单元测试 | 可并行 |
| **Tester** | 集成测试、边界测试、目标是找 bug | 1 |
| **Critic** | 代码审查、安全审计、目标是发现问题 | 1 |

---

## 8. 待您决策的问题汇总

请对以下问题给出您的决定：

1. **[密码学]** 是否使用 `k256` crate 实现 secp256k1？（推荐: 是）
2. **[哈希]** 是否自研 Keccak-256？（推荐: 是，约500行代码）
3. **[存储]** MVP 阶段是否自研简化 KV 存储？（推荐: 是）
4. **[网络]** 是否使用 `tokio` 做异步网络？（推荐: 是）
5. **[大整数]** 是否自研 U256？（推荐: 是，约1000行代码）
6. **[阶段]** 是否同意上述 6 阶段开发计划？

---

## 9. 下一步

待您确认后，我将：

1. 初始化 Cargo workspace
2. 创建各 crate 骨架
3. 定义核心 trait 接口
4. 开始 Phase 1 实现

---

*报告结束 - 等待您的决策*
