# BachLedger - 剩余决策点与风险分析

> 报告编号: REPORT-003
> 日期: 2026-02-06
> 状态: 待确认

---

## 已确认决策

| 组件 | 选择 |
|------|------|
| 签名算法 | k256 (纯 Rust) |
| 哈希函数 | sha3 crate |
| 大整数 | primitive-types |
| 存储层 | RocksDB |
| 可观测性 | JSON + CLI 仪表盘 |

---

## 1. 待确认决策

### 1.1 网络与并发模型

| 选项 | 优点 | 缺点 | 建议 |
|------|------|------|------|
| **A: tokio 异步** | 高并发，资源利用率高，生态成熟 | 学习曲线，调试稍复杂 | **推荐** |
| B: std::thread 同步 | 简单直接 | 扩展性差，资源消耗大 | 不推荐 |

**决策点**: 是否使用 `tokio` 作为异步运行时？

---

### 1.2 序列化格式

| 选项 | 优点 | 缺点 | 建议 |
|------|------|------|------|
| **A: RLP (以太坊兼容)** | 与以太坊工具链兼容，可复用生态 | 需要实现或引入 rlp crate | **推荐** |
| B: bincode/borsh | 性能更高，Rust 原生 | 不兼容以太坊 | 不推荐 |
| C: 自研 | 完全控制 | 工作量大，无必要 | 不推荐 |

**决策点**: 是否使用 `rlp` crate 实现以太坊兼容序列化？

---

### 1.3 交易与地址格式

| 维度 | 以太坊兼容 | 自定义 | 建议 |
|------|------------|--------|------|
| 地址格式 | 20 bytes (0x...) | 可自定义 | **以太坊兼容** |
| 交易结构 | EIP-155/1559 | 可简化 | **以太坊兼容** |
| 签名格式 | v, r, s | 可自定义 | **以太坊兼容** |

**决策点**: 是否完全兼容以太坊交易格式？（推荐: 是，便于复用工具和钱包）

---

### 1.4 EVM 版本与预编译合约

| 预编译合约 | 地址 | 功能 | 建议 |
|------------|------|------|------|
| ecRecover | 0x01 | 签名恢复 | **必须** |
| SHA256 | 0x02 | SHA256 哈希 | **必须** |
| RIPEMD160 | 0x03 | RIPEMD160 哈希 | 可选 |
| identity | 0x04 | 数据复制 | **必须** |
| modexp | 0x05 | 大整数模幂 | 可选 |
| bn128Add | 0x06 | 椭圆曲线加法 | 可选 |
| bn128Mul | 0x07 | 椭圆曲线乘法 | 可选 |
| bn128Pairing | 0x08 | 椭圆曲线配对 | 可选 |
| blake2f | 0x09 | BLAKE2 压缩 | 可选 |

**决策点**:
1. MVP 阶段实现哪些预编译合约？（建议: 0x01-0x04 必须，其他可选）
2. 目标 EVM 版本？（建议: Shanghai，最新稳定版）

---

### 1.5 TBFT 共识参数

| 参数 | 以太坊/Tendermint 默认 | 建议值 | 说明 |
|------|------------------------|--------|------|
| 出块间隔 | 12s / 1s | **500ms** | 联盟链可更快 |
| 提案超时 | 3s | **1s** | |
| 预投票超时 | 1s | **500ms** | |
| 预提交超时 | 1s | **500ms** | |
| 最大区块大小 | 1MB | **2MB** | |
| 每块最大交易数 | 不限 | **1000** | 便于测试 |

**决策点**: 是否同意上述默认参数？（可后期调整）

---

### 1.6 日志框架

| 选项 | 特点 | 建议 |
|------|------|------|
| **A: tracing** | 结构化日志，支持 span，与 tokio 集成好 | **推荐** |
| B: log + env_logger | 简单，传统 | 备选 |
| C: 自研 | 无必要 | 不推荐 |

**决策点**: 是否使用 `tracing` 作为日志框架？

---

### 1.7 错误处理

| 选项 | 特点 | 建议 |
|------|------|------|
| **A: thiserror** | 派生宏，类型安全，轻量 | **推荐** |
| B: anyhow | 动态错误，适合应用层 | 配合使用 |
| C: 自研 | 工作量大 | 不推荐 |

**决策点**: 是否使用 `thiserror` + `anyhow` 组合？

---

## 2. 风险分析

### 2.1 技术风险

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           风险矩阵                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  影响 ▲                                                                  │
│  高   │   ┌─────────┐                    ┌─────────┐                    │
│       │   │ EVM 实现 │                    │TBFT Bug │                    │
│       │   │ 不完整   │                    │导致分叉  │                    │
│       │   └─────────┘                    └─────────┘                    │
│  中   │          ┌─────────────┐    ┌─────────────┐                     │
│       │          │ Seamless    │    │ 性能不达标  │                     │
│       │          │ 算法有Bug   │    │             │                     │
│       │          └─────────────┘    └─────────────┘                     │
│  低   │                         ┌─────────────┐                         │
│       │                         │  依赖升级   │                         │
│       │                         │  不兼容     │                         │
│       │                         └─────────────┘                         │
│       └─────────────────────────────────────────────────────▶ 可能性    │
│              低              中              高                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 风险 R1: EVM 实现不完整

| 维度 | 内容 |
|------|------|
| **可能性** | 高 |
| **影响** | 高 - 合约无法正确执行 |
| **缓解措施** | 使用 Ethereum 官方测试向量 (ethereum/tests) 验证每个操作码 |
| **检测方法** | 每个操作码必须有对应测试用例，覆盖率 > 95% |
| **应急方案** | 发现问题时可参考 revm (Rust EVM) 实现 |

#### 风险 R2: TBFT 共识 Bug 导致分叉

| 维度 | 内容 |
|------|------|
| **可能性** | 中 |
| **影响** | 高 - 网络分裂，数据不一致 |
| **缓解措施** | 1. 严格按照 Tendermint 论文实现<br>2. 模拟网络分区测试<br>3. 拜占庭节点注入测试 |
| **检测方法** | 多节点长时间运行测试，检查状态一致性 |
| **应急方案** | 简化为单节点模式，逐步增加节点 |

#### 风险 R3: Seamless Scheduling 算法 Bug

| 维度 | 内容 |
|------|------|
| **可能性** | 中 |
| **影响** | 中 - 执行结果不确定性 |
| **缓解措施** | 1. 论文算法形式化验证<br>2. 大量并发测试<br>3. 与顺序执行结果对比 |
| **检测方法** | 相同交易集合，并行 vs 串行结果必须一致 |
| **应急方案** | 可 fallback 到串行执行模式 |

#### 风险 R4: 性能不达标

| 维度 | 内容 |
|------|------|
| **可能性** | 中 |
| **影响** | 中 - 无法达到论文声称的性能 |
| **缓解措施** | 1. 每阶段建立 benchmark<br>2. 可观测性系统定位瓶颈<br>3. 预留优化空间 |
| **检测方法** | 持续 benchmark，对比论文数据 |
| **应急方案** | 针对瓶颈点专项优化 |

---

### 2.2 进度风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 模块接口不匹配 | 中 | 中 | 先定义 trait 接口，再实现 |
| 测试用例不充分 | 高 | 中 | Tester 独立编写，目标是找 bug |
| 文档滞后 | 高 | 低 | 每个 PR 必须更新文档 |
| 依赖库 API 变更 | 低 | 低 | 锁定依赖版本 |

---

### 2.3 安全风险

| 风险 | 说明 | 缓解措施 |
|------|------|----------|
| 整数溢出 | EVM 计算中可能溢出 | 使用 checked_* 操作，启用溢出检查 |
| 重入攻击 | 合约调用中的重入 | EVM 实现中正确处理 call depth |
| 签名可塑性 | ECDSA 签名可塑性 | 使用 low-s 规范化 |
| 拒绝服务 | 恶意大 gas 交易 | gas limit 检查，超时机制 |

---

## 3. 外部依赖汇总

### 3.1 最终依赖清单

```toml
[workspace.dependencies]
# 密码学
k256 = "0.13"              # secp256k1 ECDSA
sha3 = "0.10"              # Keccak-256

# 数据类型
primitive-types = "0.12"    # U256, H256

# 存储
rocksdb = "0.22"           # KV 存储

# 序列化
rlp = "0.5"                # 以太坊 RLP 编码

# 异步运行时
tokio = { version = "1", features = ["full"] }

# 日志
tracing = "0.1"
tracing-subscriber = "0.3"

# 错误处理
thiserror = "1"
anyhow = "1"

# 测试
proptest = "1"             # 属性测试
criterion = "0.5"          # 基准测试
```

### 3.2 依赖分类

```
┌─────────────────────────────────────────────────────────────┐
│                      依赖分层图                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   应用层依赖                         │    │
│  │  tracing, thiserror, anyhow                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   运行时依赖                         │    │
│  │  tokio                                              │    │
│  └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   领域依赖                           │    │
│  │  k256, sha3, rlp, primitive-types                   │    │
│  └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   基础设施依赖                       │    │
│  │  rocksdb                                            │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  总计: 11 个直接依赖（不含测试依赖）                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 决策汇总清单

请确认以下决策（Y/N 或提出修改）：

| # | 决策项 | 推荐选项 | 您的决定 |
|---|--------|----------|----------|
| 1 | 异步运行时 | tokio | |
| 2 | 序列化格式 | rlp (以太坊兼容) | |
| 3 | 交易格式 | 以太坊兼容 | |
| 4 | MVP 预编译合约 | 0x01-0x04 | |
| 5 | EVM 版本 | Shanghai | |
| 6 | TBFT 默认参数 | 见上表 | |
| 7 | 日志框架 | tracing | |
| 8 | 错误处理 | thiserror + anyhow | |

---

## 5. 无需确认（开发团队自行决定）

以下事项由开发团队自行决定，无需您确认：

- 代码目录结构细节
- 内部函数命名规范
- 测试用例组织方式
- CI/CD 配置细节
- 代码格式化配置

---

*报告结束 - 等待您确认第 4 节的 8 个决策项*
